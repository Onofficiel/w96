//!wrt $BSPEC:{"icn":"C:/local/border/res/img/icon32.png","cpr":"Copyright (C) Onofficiel 2024.","dsc":"A simple yet customizable multi tab browser !","frn":"Border","aut":"Onofficiel","ver":2,"ssy":"gui"} 

function _classPrivateMethodInitSpec(t,e){_checkPrivateRedeclaration(t,e),e.add(t)}function _classPrivateMethodGet(t,e,i){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return i}function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}function _classPrivateFieldInitSpec(t,e,i){_checkPrivateRedeclaration(t,e),e.set(t,i)}function _checkPrivateRedeclaration(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateFieldGet(t,e){return _classApplyDescriptorGet(t,_classExtractFieldDescriptor(t,e,"get"))}function _classApplyDescriptorGet(t,e){return e.get?e.get.call(t):e.value}function _classPrivateFieldSet(t,e,i){return _classApplyDescriptorSet(t,_classExtractFieldDescriptor(t,e,"set"),i),i}function _classExtractFieldDescriptor(t,e,i){if(!e.has(t))throw new TypeError("attempted to "+i+" private field on non-instance");return e.get(t)}function _classApplyDescriptorSet(t,e,i){if(e.set)e.set.call(t,i);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=i}}class SemVer{constructor(t="0.0.0"){const e=t.match(/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$/);if(!e)throw new Error("Invalid version string");this.major=Number.parseInt(e[1],10),this.minor=Number.parseInt(e[2],10),this.patch=Number.parseInt(e[3],10),this.preRelease=e[4]?e[4].split("."):[],this.build=e[5]||""}[Symbol.toPrimitive](t){if("string"===t){const t=this.preRelease.length?`-${this.preRelease.join(".")}`:"",e=this.build?`+${this.build}`:"";return`${this.major}.${this.minor}.${this.patch}${t}${e}`}return"number"===t?1e6*this.major+1e3*this.minor+this.patch:null}static compare(t,e){if(!(t instanceof SemVer&&e instanceof SemVer))throw new Error("Invalid version objects");const i=Number(t),s=Number(e);return i<s?-1:i>s?1:0}static isLowerThan(t,e){return-1===SemVer.compare(t,e)}static isGreaterThan(t,e){return 1===SemVer.compare(t,e)}static isEqual(t,e){return 0===SemVer.compare(t,e)}isLowerThan(t){return-1===this.constructor.compare(this,t)}isGreaterThan(t){return 1===this.constructor.compare(this,t)}isEqual(t){return 0===this.constructor.compare(this,t)}toString(){return String(this)}}const PRODUCT={NAME:"Border Beta",get NAME_SNAKE(){return this.NAME.toLocaleLowerCase().replace(/ /g,"_")},get NAME_KEBAB(){return this.NAME.toLocaleLowerCase().replace(/ /g,"-")},get NAME_CAMEL(){return this.NAME.replace(/(?:^\w|[A-Z]|\b\w)/g,(t=>t.toUpperCase())).replace(/\s+/g,"")},VERSION:new SemVer("2.0.0-dev"),AUTHOR:"Onofficiel",get COPYRIGHT(){return`${this.NAME} (C) ${this.AUTHOR} 2024`}},PATH={APPDATA:`C:/user/appdata/${PRODUCT.NAME_KEBAB}`,LOCAL:`C:/local/${PRODUCT.NAME_KEBAB}`};var _trslDir=new WeakMap,_language=new WeakMap,_trslMap=new WeakMap;class I18n{constructor(t){_classPrivateFieldInitSpec(this,_trslDir,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_language,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_trslMap,{writable:!0,value:{}}),_classPrivateFieldSet(this,_trslDir,t)}async setLanguage(t){const e=FSUtil.resolvePath(_classPrivateFieldGet(this,_trslDir),`${t}.json`);if(!await FS.isFile(e))throw new Error(`Translation file for ${t} does not exist.`);_classPrivateFieldSet(this,_language,t),_classPrivateFieldSet(this,_trslMap,JSON.parse(await FS.readstr(e)))}t(t,e={}){if(!_classPrivateFieldGet(this,_language))throw new Error("No language set.");let i=t;const s=_classPrivateFieldGet(this,_trslMap);i=function t(e){return e.replace(/{{(.*?)}}/g,((e,i)=>{const r=i.split(".");let a=s;for(const t of r){const i=a[t];if(!i)return e;a=i}return t(a)}))}(i);for(const[t,s]of Object.entries(e))i=i.replaceAll(`%{${t}}`,s);return i}}var _stack=new WeakMap;class EventSystem{constructor(){_classPrivateFieldInitSpec(this,_stack,{writable:!0,value:[]})}on(t,e,i=!1){_classPrivateFieldGet(this,_stack).push({triggerName:t,callback:e,once:i})}emit(t,...e){for(const i of _classPrivateFieldGet(this,_stack))i.triggerName===t&&(i.callback(...e),i.once&&_classPrivateFieldGet(this,_stack).splice(_classPrivateFieldGet(this,_stack).indexOf(i),1))}remove(t){for(const e of _classPrivateFieldGet(this,_stack))e===t&&_classPrivateFieldGet(this,_stack).splice(_classPrivateFieldGet(this,_stack).indexOf(e),1)}}var _title=new WeakMap,_uri=new WeakMap;class TabInstance{constructor(t,e){_classPrivateFieldInitSpec(this,_title,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_uri,{writable:!0,value:null}),_defineProperty(this,"history",{list:[],index:0,go:async t=>{const e=this.history.index+t;if(e<0||e>this.history.list.length-1)throw new Error("History unreachable");const i=this.history.list[e];return this.setURI(i),this.history.index=e,this}}),this.tabHandler=t,this.tabHandler.tabs.push(this),this.el=t.template.cloneNode(!0),this.el.onclick=()=>this.setCurrent(),this.el.querySelector(".close").onclick=()=>this.close(),this.view=document.createElement("iframe"),this.view.classList.add("view"),this.tabHandler.tabContainer.appendChild(this.el),this.tabHandler.viewContainer.appendChild(this.view),e.current&&this.setCurrent(),this.setTitle(e.title?e.title:"Untitled"),this.setURI(e.uri?e.uri:"border://newtab"),this.tabHandler.browser.Event.emit("tab.create",this)}get isCurrent(){return this.tabHandler.current===this}setCurrent(){this.tabHandler.current=this;for(const t of this.tabHandler.tabs)t.el.classList.remove("current"),t.view.classList.remove("current");this.el.classList.add("current"),this.view.classList.add("current"),this.tabHandler.browser.Event.emit("tab.change",this)}async setURI(t){let{formattedURI:e}=await new Promise((e=>{this.tabHandler.browser.Event.emit("tab.navigate",{tab:this,query:t,resolve:e})}));return e||(e=t),_classPrivateFieldSet(this,_uri,e),this.history.list.length>0&&this.history.index!==this.history.list.length-1&&e!==this.history.list.at(this.history.index)&&(this.history.list=this.history.list.slice(0,this.history.index+1)),this.history.list.push(e),this.history.index=this.history.list.length-1,this.tabHandler.browser.history.add(e),this.tabHandler.browser.root.querySelector(".location-bar>input").value=e,this}get uri(){return _classPrivateFieldGet(this,_uri)}get title(){return _classPrivateFieldGet(this,_title)}setTitle(t){_classPrivateFieldSet(this,_title,t),this.el.querySelector(".title").innerText=t}async reload(){return await new Promise((t=>{this.tabHandler.browser.Event.emit("tab.navigate",{tab:this,query:this.uri,resolve:t})})),this.view.src}close(){this.el.onclick=null,this.el.querySelector(".close").onclick=null,this.tabHandler.tabs.length<=1?this.tabHandler.browser.ctx.terminate():(this.el.remove(),this.view.remove(),this.tabHandler.tabs.splice(this.tabHandler.tabs.indexOf(this),1),this.isCurrent&&this.tabHandler.tabs.at(-1).setCurrent(),this.tabHandler.browser.Event.emit("tab.close",this))}}var _Instance=new WeakMap;class TabHandler{constructor(t,e,i){_defineProperty(this,"tabs",[]),_classPrivateFieldInitSpec(this,_Instance,{writable:!0,value:TabInstance}),_defineProperty(this,"current",null),this.browser=t,this.tabContainer=e,this.viewContainer=i}create(t){return new(_classPrivateFieldGet(this,_Instance))(this,t)}}var _setNamespaces=new WeakSet;class Blugin{constructor(t,e,i){_classPrivateMethodInitSpec(this,_setNamespaces),this.browser=t,this.path=e,this.opts={system:!1,access:[],meta:{},id:null,container:t.root.querySelector(".blugin-container"),...i},this.env=document.createElement("iframe"),Object.assign(this.env,{hidden:!0,width:0,height:0})}get context(){return this.env.contentWindow}get meta(){var t;return{name:FSUtil.fname(this.path).slice(0,-3),description:"<no description>",version:new SemVer("1.0.0"),author:"<no author>",...this.opts.meta,...null===(t=this.context)||void 0===t||null===(t=t.Blugin)||void 0===t?void 0:t.meta}}get id(){return this.opts.id}async load(){let t;const e=new Promise((e=>{t=e}));this.env.addEventListener("load",(()=>{if(!this.context)return;const e=this.context;e.parent=void 0,e.addEventListener("beforeunload",(()=>{this.kill()}));const{BLUGIN_NS:i,BROWSER_NS:s}=_classPrivateMethodGet(this,_setNamespaces,_setNamespaces2).call(this);this.context.SemVer=SemVer,this.context.Blugin=i,this.context[PRODUCT.NAME_CAMEL]=this.context.Border=s,this.context.alert=alert,this.context.PRODUCT=PRODUCT,this.context.PATH=PATH,this.context.RT_VERSION=this.constructor.RT_VERSION;new MutationObserver((function(t,e){e.disconnect();for(const e of t){for(const t of e.addedNodes)t.remove();e.attributeName&&e.target.removeAttribute(e.attributeName);for(const t of e.removedNodes)e.target.insertBefore(t,e.nextSibling)}})).observe(e.document.documentElement,{childList:!0,attributes:!0,subtree:!0}),e.dispatchEvent(new Event("blugin-config-ready")),t()}),{once:!0}),this.env.src=`/_${PATH.LOCAL.slice(2)}/res/ui/blugin_env.html`,this.opts.container&&this.opts.container.appendChild(this.env),await e}async kill(){this.env.src="about:blank"}}function _setNamespaces2(){const t=new Set(this.opts.access);function e(e){return t.has(e)||t.has("*")}const i={meta:{...this.opts.meta},exports:{},scriptPath:this.path,Event:new EventSystem,exit:async()=>{await this.kill()}},s={i18n:this.browser.i18n};return e("tab")&&(s.Tab=this.browser.Tab),e("window")&&(s.wnd=this.browser.wnd,s.root=this.browser.root),e("process")&&(s.ctx=this.browser.ctx,s.exit=this.browser.exit,s.restart=this.browser.restart,s.newWindow=this.browser.newWindow),e("event")&&(s.Event=this.browser.Event),e("blugin")&&(s.Blugin=this.browser.Blugin),e("history")&&(s.history=this.browser.history),e("config")&&(s.config=this.browser.config),e("w96")&&(this.context.w96=w96),{BLUGIN_NS:i,BROWSER_NS:s}}_defineProperty(Blugin,"RT_VERSION",new SemVer("2.0.0"));class BluginHandler{constructor(t,e){_defineProperty(this,"blugins",new Set),this.browser=t,this.configPath=e,this.container=document.createElement("div"),this.container.classList.add("blugin-container"),Object.assign(this.container.style,{width:0,height:0,display:"none"}),console.debug("BluginHandler",this.browser.root),this.browser.root.appendChild(this.container)}async getConfig(){return w96.yaml.load(await w96.FS.readstr(this.configPath))||{}}async setConfig(t){await w96.FS.writestr(this.configPath,w96.yaml.dump(t))}async isActive(t){var e;return!(null!==(e=(await this.getConfig()).desactivated)&&void 0!==e&&e.includes(t.id))}async desactivateBlugin(t){const e=await this.getConfig();e.desactivated||(e.desactivated=[]),e.desactivated.push(t.id),await t.kill(),await this.setConfig(e)}async activateBlugin(t){const e=await this.getConfig();e.desactivated||(e.desactivated=[]),e.desactivated=e.desactivated.filter((e=>e!==t.id)),await t.load(),await this.setConfig(e)}async addBlugin(t,e){const i=new Blugin(this.browser,t,{container:this.container,...e});return this.blugins.add(i),i}async loadBlugins(){for(const e of this.blugins){var t;null!==(t=(await this.getConfig()).desactivated)&&void 0!==t&&t.includes(e.id)||await e.load()}}async removeBlugin(t){t.kill(),this.blugins.delete(t)}}var _list=new WeakMap,_updateFile=new WeakSet,_init=new WeakSet;class HistoryHandler{get list(){return _classPrivateFieldGet(this,_list)}add(t){t!==_classPrivateFieldGet(this,_list).at(-1)&&(_classPrivateFieldGet(this,_list).push(t),_classPrivateMethodGet(this,_updateFile,_updateFile2).call(this))}remove(t){_classPrivateFieldGet(this,_list).splice(t,1),_classPrivateMethodGet(this,_updateFile,_updateFile2).call(this)}clear(){_classPrivateFieldSet(this,_list,[]),_classPrivateMethodGet(this,_updateFile,_updateFile2).call(this)}constructor(t){_classPrivateMethodInitSpec(this,_init),_classPrivateMethodInitSpec(this,_updateFile),_classPrivateFieldInitSpec(this,_list,{writable:!0,value:[]}),this.historyFile=t,_classPrivateMethodGet(this,_init,_init2).call(this)}}async function _updateFile2(){await FS.writestr(this.historyFile,_classPrivateFieldGet(this,_list).join("\n"))}async function _init2(){if(await FS.isFile(this.historyFile)&&!await FS.isEmpty(this.historyFile)){const t=await FS.readstr(this.historyFile);_classPrivateFieldSet(this,_list,t.split("\n"))}}function replaceTemplate(t){return t.replaceAll("%local%",`/_/${PATH.LOCAL.replace(":","")}`).replaceAll("%appdata%",`/_/${PATH.APPDATA.replace(":","")}`)}var _init3=new WeakSet;class Browser{constructor(t,e,i){_classPrivateMethodInitSpec(this,_init3),_defineProperty(this,"Event",new EventSystem);const s={safeMode:!1,...i};this.root=t.getBodyContainer(),this.wnd=t,this.ctx=e,this.safeMode=s.safeMode,_classPrivateMethodGet(this,_init3,_init4).call(this)}exit(){this.ctx.terminate()}newWindow(){const{launchCommand:t}=this.ctx.execCtx;w96.sys.execFile(t)}restart(){this.newWindow(),this.exit()}}async function _init4(){this.config=w96.yaml.load(await FS.readstr(`${PATH.APPDATA}/config.yml`)),this.i18n=new I18n(`${PATH.APPDATA}/translations`),await this.i18n.setLanguage(this.config.interface.language).catch((t=>{console.error(t),showExceptionWindow(`Error during language setup\n${t.message}`),this.exit()})),this.root.innerHTML=this.i18n.t(replaceTemplate(await include(`${PATH.LOCAL}/res/ui/browser.html`))),this.history=new HistoryHandler(`${PATH.APPDATA}/history.txt`),this.Tab=new TabHandler(this,this.root.querySelector(".tab-container"),this.root.querySelector(".view-container"));const t=new DOMParser;this.Tab.template=t.parseFromString(replaceTemplate(await include(`${PATH.LOCAL}/res/ui/tab.html`)),"text/html").body.firstChild,this.Blugin=new BluginHandler(this,`${PATH.APPDATA}/blugins-config.yml`),this.Event.emit("init-complete")}const OPTION_MARKER="--";function collectOptions(t,e){const i=[],s=[],r={valueOptions:[],...e};for(let e=0;e<t.length;e++){const a=t[e];if(a.startsWith(OPTION_MARKER)){const s=a.substring(OPTION_MARKER.length);if(r.valueOptions.includes(s)){const r=t[e+1];if(null==r||r.startsWith(OPTION_MARKER))throw new Error(`'${OPTION_MARKER}${s}' requires an argument.`);i.push({name:s,value:r}),e++}else i.push({name:s,value:null})}else s.push(a)}return{options:i,remainder:s}}const{yaml:yaml}=w96,{INI:INI}=w96.util;async function main(t,e,i){const s=collectOptions(i.slice(1),{valueOptions:["--url"]}),r=new Browser(t,e,{safeMode:!!s.options.find((({name:t})=>"safe"===t))});r.Event.on("init-complete",(async()=>{let e="border://newtab";const i=s.options.find((({name:t})=>"url"===t));if(i)e=i.value;else if(s.remainder.length>0){const t=s.remainder[0];if(".url"===FSUtil.getExtension(t)){e=INI.parse(await FS.readstr(t)).InternetShortcut.URL}else e=t}console.log(e);for(const t of await FS.readdir(`${PATH.LOCAL}/sys-blugins`))await FS.isFile(t)&&await r.Blugin.addBlugin(t,{access:["*"],system:!0});r.safeMode||await async function(t){for(const e of await FS.readdir(t)){if(await FS.isFile(e))continue;const t=`${e}/manifest.yml`;if(!await FS.isFile(t))throw new Error(`The manifest.yml of the blugin "${e}" doesn't exist`);let i;try{i=w96.yaml.load(await w96.FS.readstr(t))}catch(t){throw new Error(`The manifest.yml of the blugin "${e}" is invalid: ${t}`)}const s=FSUtil.resolvePath(e,i.entry);if(!await FS.isFile(s))throw new Error(`The entry file of the blugin "${e}" doesn't exist`);await r.Blugin.addBlugin(s,{access:i.permissions,meta:i.meta,id:FSUtil.fname(e)})}}(`${PATH.APPDATA}/blugins`).catch((t=>{console.error(t),showExceptionWindow(t)})),await r.Blugin.loadBlugins(),console.debug(e),r.Tab.create({uri:e,current:!0}),t.show(),window.BorderI=r}))}StandardWindow;const{showExceptionWindow:showExceptionWindow}=w96.ui;class BorderApplication extends WApplication{async main(t){if(super.main(t),!await require_check(["SWFSBridge"]))return void this.terminate();const e=this.createWindow({title:PRODUCT.NAME,icon:await FS.toURL(`${PATH.LOCAL}/res/img/icon16.png`),body:"",windowClass:"border-wnd",bodyClass:"border",taskbar:!0,noCompose:!0,initialWidth:700,initialHeight:550},!0);await main(e,this,t).catch((t=>{console.error(t),showExceptionWindow(t),this.terminate()}))}}

return await WApplication.execAsync(new BorderApplication(), this.boxedEnv.args, this);